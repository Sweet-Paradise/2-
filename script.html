document.addEventListener('DOMContentLoaded', function() {
    // ======================
    // Мобильное меню
    // ======================
    const menuToggle = document.querySelector('.menu-toggle');
    const mainNav = document.querySelector('.main-nav');
    const navLinks = document.querySelectorAll('.main-nav a');
    
    menuToggle.addEventListener('click', function() {
        this.classList.toggle('active');
        mainNav.classList.toggle('active');
        document.body.classList.toggle('no-scroll');
    });
    
    navLinks.forEach(link => {
        link.addEventListener('click', function() {
            menuToggle.classList.remove('active');
            mainNav.classList.remove('active');
            document.body.classList.remove('no-scroll');
        });
    });
    
    // ======================
    // Плавная прокрутка
    // ======================
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            
            const targetId = this.getAttribute('href');
            if (targetId === '#') return;
            
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                const headerHeight = document.querySelector('.header').offsetHeight;
                const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight;
                
                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
            }
        });
    });
    
    // ======================
    // Фиксированная шапка
    // ======================
    const header = document.querySelector('.header');
    let lastScroll = 0;
    
    window.addEventListener('scroll', function() {
        const currentScroll = window.pageYOffset;
        
        if (currentScroll <= 0) {
            header.classList.remove('scrolled');
            return;
        }
        
        if (currentScroll > lastScroll && currentScroll > 100) {
            // Прокрутка вниз
            header.classList.add('hide');
        } else {
            // Прокрутка вверх
            header.classList.remove('hide');
        }
        
        if (currentScroll > 100) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
        
        lastScroll = currentScroll;
    });
    
    // ======================
    // Кнопка "Наверх"
    // ======================
    const scrollTop = document.querySelector('.scroll-top');
    
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            scrollTop.classList.add('show');
        } else {
            scrollTop.classList.remove('show');
        }
    });
    
    // ======================
    // Слайдер отзывов
    // ======================
    const reviewsSlider = document.querySelector('.reviews-slider');
    let isDown = false;
    let startX;
    let scrollLeft;
    
    if (reviewsSlider) {
        reviewsSlider.addEventListener('mousedown', (e) => {
            isDown = true;
            reviewsSlider.classList.add('active');
            startX = e.pageX - reviewsSlider.offsetLeft;
            scrollLeft = reviewsSlider.scrollLeft;
        });
        
        reviewsSlider.addEventListener('mouseleave', () => {
            isDown = false;
            reviewsSlider.classList.remove('active');
        });
        
        reviewsSlider.addEventListener('mouseup', () => {
            isDown = false;
            reviewsSlider.classList.remove('active');
        });
        
        reviewsSlider.addEventListener('mousemove', (e) => {
            if(!isDown) return;
            e.preventDefault();
            const x = e.pageX - reviewsSlider.offsetLeft;
            const walk = (x - startX) * 2;
            reviewsSlider.scrollLeft = scrollLeft - walk;
        });
        
        // Для тач-устройств
        reviewsSlider.addEventListener('touchstart', (e) => {
            isDown = true;
            reviewsSlider.classList.add('active');
            startX = e.touches[0].pageX - reviewsSlider.offsetLeft;
            scrollLeft = reviewsSlider.scrollLeft;
        });
        
        reviewsSlider.addEventListener('touchend', () => {
            isDown = false;
            reviewsSlider.classList.remove('active');
        });
        
        reviewsSlider.addEventListener('touchmove', (e) => {
            if(!isDown) return;
            e.preventDefault();
            const x = e.touches[0].pageX - reviewsSlider.offsetLeft;
            const walk = (x - startX) * 2;
            reviewsSlider.scrollLeft = scrollLeft - walk;
        });
    }
    
    // ======================
    // Анимации при прокрутке
    // ======================
    const animateElements = () => {
        const elements = document.querySelectorAll('[data-aos]');
        const windowHeight = window.innerHeight;
        const windowTop = window.pageYOffset;
        const windowBottom = windowTop + windowHeight;
        
        elements.forEach(element => {
            const elementHeight = element.offsetHeight;
            const elementTop = element.getBoundingClientRect().top + windowTop;
            const elementBottom = elementTop + elementHeight;
            
            // Проверяем, находится ли элемент в области видимости
            if (elementBottom >= windowTop && elementTop <= windowBottom) {
                element.classList.add('aos-animate');
            } else {
                // Опционально: удаляем класс при скролле назад
                // element.classList.remove('aos-animate');
            }
        });
    };
    
    window.addEventListener('scroll', animateElements);
    window.addEventListener('load', animateElements);
    
    // ======================
    // Модальное окно бронирования
    // ======================
    const bookingButtons = document.querySelectorAll('.book-btn, .booking-btn');
    const bookingModal = document.getElementById('booking-modal');
    const closeModal = document.querySelectorAll('.modal .close');
    
    if (bookingModal) {
        // Открытие модального окна
        bookingButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const roomId = this.getAttribute('data-room-id');
                const roomName = this.closest('.room-card')?.querySelector('h3')?.textContent;
                
                if (roomId) {
                    document.getElementById('room-id').value = roomId;
                }
                
                if (roomName) {
                    bookingModal.querySelector('h2').textContent = `Бронирование: ${roomName}`;
                }
                
                bookingModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            });
        });
        
        // Закрытие модального окна
        closeModal.forEach(btn => {
            btn.addEventListener('click', function() {
                bookingModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        });
        
        // Закрытие при клике вне модального окна
        window.addEventListener('click', function(e) {
            if (e.target === bookingModal) {
                bookingModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
        
        // Валидация формы
        const bookingForm = document.getElementById('booking-form');
        if (bookingForm) {
            bookingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Простая валидация
                let isValid = true;
                const inputs = this.querySelectorAll('input[required]');
                
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('error');
                        isValid = false;
                    } else {
                        input.classList.remove('error');
                    }
                });
                
                if (isValid) {
                    // Здесь можно добавить AJAX-отправку формы
                    alert('Заявка отправлена! Мы свяжемся с вами в ближайшее время.');
                    this.reset();
                    bookingModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
        }
    }
    
    // ======================
    // Инициализация карты
    // ======================
    function initMap() {
        // Координаты для центра карты
        const center = [59.938635, 30.323118];
        
        // Создание карты
        const map = new ymaps.Map('map', {
            center: center,
            zoom: 15
        });
        
        // Добавление метки
        const placemark = new ymaps.Placemark(center, {
            hintContent: 'Гостиница "Котейка"',
            balloonContent: 'ул. Котикова, 8, Санкт-Петербург'
        }, {
            iconLayout: 'default#image',
            iconImageHref: 'images/map-marker.png',
            iconImageSize: [40, 40],
            iconImageOffset: [-20, -40]
        });
        
        map.geoObjects.add(placemark);
        
        // Отключение скролла колесом мыши
        map.behaviors.disable('scrollZoom');
    }
    
    // Проверяем, подключен ли API Яндекс.Карт
    if (typeof ymaps !== 'undefined') {
        ymaps.ready(initMap);
    } else {
        // Если API не загружен, можно загрузить его динамически
        const script = document.createElement('script');
        script.src = 'https://api-maps.yandex.ru/2.1/?lang=ru_RU&onload=initMap';
        document.head.appendChild(script);
    }
    
    // ======================
    // Активный пункт меню при скролле
    // ======================
    const sections = document.querySelectorAll('section[id]');
    
    function updateActiveNav() {
        let current = '';
        
        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.offsetHeight;
            const headerHeight = document.querySelector('.header').offsetHeight;
            
            if (window.pageYOffset >= sectionTop - headerHeight - 50 && 
                window.pageYOffset < sectionTop + sectionHeight - headerHeight - 50) {
                current = section.getAttribute('id');
            }
        });
        
        navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${current}`) {
                link.classList.add('active');
            }
        });
    }
    
    window.addEventListener('scroll', updateActiveNav);
    
    // ======================
    // Инициализация при загрузке
    // ======================
    updateActiveNav();
    header.classList.add('scrolled');
});
